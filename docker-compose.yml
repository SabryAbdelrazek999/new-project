services:
  app:
    build: .
    container_name: zap_app
    env_file:
      - .env
    ports:
      - "5000:5000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./reports:/app/reports
    restart: unless-stopped
    environment:
      - TZ=Africa/Cairo
      - NODE_ENV=production
      - HOST_PORT=5000
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    dns:
      - 8.8.8.8
      - 1.1.1.1

  db:
    image: postgres:15-alpine
    container_name: zap_db
    env_file:
      - .env
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: SecurePass123!
      POSTGRES_DB: zapdb
      TZ: Africa/Cairo
    ports:
      - "5432:5432"
    volumes:
      - zap_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d zapdb" ]
      interval: 10s
      timeout: 5s
      retries: 5

  zap:
    image: owasp/zap2docker-stable:latest
    container_name: zap_daemon
    ports:
      - "8081:8080"
    volumes:
      - zap_data:/zap/wrk
    command:
      - zap.sh
      - -daemon
      - -host
      - 0.0.0.0
      - -port
      - "8080"
      - -config
      - api.disablekey=true
      - -config
      - api.addrs.addr.name=.*
      - -config
      - api.addrs.addr.regex=true
      - -config
      - database.response.body.size=52428800
      - -config
      - database.request.body.size=52428800
      - -config
      - database.newsession=true
      - -config
      - database.newsessionprompt=false
    restart: unless-stopped
    profiles:
      - zap
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  dependency-check:
    image: owasp/dependency-check
    container_name: zap_depcheck
    volumes:
      - ./:/src
      - ./reports:/report
      - depcheck_data:/usr/share/dependency-check/data
    command: --scan /src --format "ALL" --project "GradProject" --out /report
    profiles:
      - tools

  nikto:
    image: secsi/nikto
    container_name: zap_nikto
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./reports:/reports
    entrypoint: [ "/bin/sh", "-c" ]
    command: [ "nikto -h http://app:5000 -o /reports/nikto-report.html -Format htm || true" ]
    profiles:
      - tools

volumes:
  zap_db_data:
  depcheck_data:
  zap_data:
